name: Training Pipeline

on:
  push:
    paths:
      - 'MLProject/**'
      - '.github/workflows/training.yml'
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mlflow==2.19.0 pandas scikit-learn

    - name: Run MLflow Project
      run: |
        cd MLProject
        # Clean up existing mlruns to avoid picking up local artifacts with invalid paths
        rm -rf mlruns
        mlflow run . --env-manager=local --experiment-name Titanic_Basic_Model

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Push Docker Image
      if: success()
      run: |
        cd MLProject
        
        export MLFLOW_TRACKING_URI=file://$(pwd)/mlruns
        
        # Search for the run in the specific experiment "Titanic_Basic_Model"
        RUN_ID=$(python -c "import mlflow; runs = mlflow.search_runs(experiment_names=['Titanic_Basic_Model']); print(runs.iloc[0].run_id if not runs.empty else 'none')")
        
        if [ "$RUN_ID" != "none" ]; then
          echo "Found latest Run ID: $RUN_ID"
          
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/sistemml01:latest"
          
          # Generate Dockerfile explicitly to modify mirrors (equivalent to mlflow models build-docker but more flexible)
          mlflow models generate-dockerfile --model-uri "runs:/$RUN_ID/model" --output-directory model_docker_build
          
          # Replace Ubuntu mirrors with Azure mirrors (more reliable in GitHub Actions)
          sed -i 's/archive.ubuntu.com/azure.archive.ubuntu.com/g' model_docker_build/Dockerfile
          sed -i 's/security.ubuntu.com/azure.archive.ubuntu.com/g' model_docker_build/Dockerfile
          
          # Build and push
          docker build -t "$IMAGE_NAME" model_docker_build
          docker push "$IMAGE_NAME"
        else
          echo "No run found to build docker image."
          exit 1
        fi

    - name: Docker Scout Scan
      if: success()
      uses: docker/scout-action@v1
      with:
        command: quickview,cves,recommendations
        image: ${{ secrets.DOCKER_USERNAME }}/sistemml01:latest
        summary: true
        ignore-unchanged: true
        only-severities: critical,high
        write-comment: true
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload MLflow Runs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mlruns
        path: MLProject/mlruns
